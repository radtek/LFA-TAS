DECLARE @var1 VARCHAR(256) ,@var2 VARCHAR(256),@var3 VARCHAR(256),@var4 VARCHAR(256),@var5 VARCHAR(256);
set @var1='{DealerId}';
set @var2='{InsurerId}';
set @var3='{ReinsurerId}';
set @var4='{FromMonthId}';
set @var5='{ToMonthId}';

SELECT a.PolicyNo, c.InsurerFullName as cedent, d.DealerName as dealer, a.status, itst.[Status] as new, e.CountryName as country, LEFT(a.month, 3) as month,  CONVERT(varchar, isnull(i.EndDate,GETDATE()),101) as invoiceDate, RIGHT('00000' + CONVERT(VARCHAR(11),isnull(i.SequenceNo,0)),6) as invoiceNo, isnull(vd.VehiclePrice, 0) * mulpleVal as sumInsured, 1 as noOfUnits, a.grossPremium * mulpleVal  as grossPremium , a.GrossPremiumBeforeTax * mulpleVal as GrossPremiumExTax ,
Isnull((SELECT CASE WHEN ccm.ispercentage = 1 THEN ccm.commission * (CASE WHEN ccm.isonnrp = 1 THEN a.nrpUs ELSE a.grossPremium-(a.TotalTax/LocalCurrencyConversionRate) END) / 100 ELSE ccm.commission END FROM nrpcommissioncontractmapping ccm INNER JOIN nrpcommissiontypes cot ON cot.id = ccm.nrpcommissionid WHERE ccm.contractid = a.contractid AND cot.NAME LIKE ( '%Marketing%' )), 0)  * mulpleVal AS MarketingFee,
Isnull((SELECT TOP 1 CASE WHEN ccm.ispercentage = 1 THEN ccm.commission * (CASE WHEN ccm.isonnrp = 1 THEN ph.Premium ELSE ph.Premium END) / 100 ELSE ccm.commission END FROM nrpcommissioncontractmapping ccm INNER JOIN nrpcommissiontypes cot ON cot.id = ccm.nrpcommissionid WHERE ccm.contractid = a.contractid AND cot.NAME LIKE ( '%Sales%' )), 0) * mulpleVal AS salesComm,
Isnull((SELECT TOP 1 CASE WHEN ccm.ispercentage = 1 THEN ccm.commission * (CASE WHEN ccm.isonnrp = 1 THEN a.nrpUs ELSE a.grossPremium-(a.TotalTax/LocalCurrencyConversionRate) END) / 100 ELSE ccm.commission END FROM nrpcommissioncontractmapping ccm INNER JOIN nrpcommissiontypes cot ON cot.id = ccm.nrpcommissionid WHERE ccm.contractid = a.contractid AND cot.NAME LIKE ( 'Manufacture Commission%' )), 0) * mulpleVal  AS manfComm,
Isnull((SELECT TOP 1 CASE WHEN ccm.ispercentage = 1 THEN ccm.commission * (CASE WHEN ccm.isonnrp = 1 THEN a.nrpUs ELSE a.grossPremium-(a.TotalTax/LocalCurrencyConversionRate) END) / 100 ELSE ccm.commission END FROM nrpcommissioncontractmapping ccm INNER JOIN nrpcommissiontypes cot ON cot.id = ccm.nrpcommissionid WHERE ccm.contractid = a.contractid AND cot.NAME LIKE ( '%Insurer Fee%' )), 0) * mulpleVal  AS cedentFee,
Isnull((SELECT TOP 1 CASE WHEN ccm.ispercentage = 1 THEN ccm.commission * (CASE WHEN ccm.isonnrp = 1 THEN a.nrpUs ELSE a.grossPremium-(a.TotalTax/LocalCurrencyConversionRate) END) / 100 ELSE ccm.commission END FROM nrpcommissioncontractmapping ccm INNER JOIN nrpcommissiontypes cot ON cot.id = ccm.nrpcommissionid WHERE ccm.contractid = a.contractid AND cot.NAME LIKE ( '%Document%' )), 0) * mulpleVal  AS docFee,
Isnull((SELECT CASE WHEN ccm.ispercentage = 1 THEN ccm.commission * (CASE WHEN ccm.isonnrp = 1 THEN a.nrpUs ELSE a.grossPremium-(a.TotalTax/LocalCurrencyConversionRate) END) / 100 ELSE ccm.commission END FROM nrpcommissioncontractmapping ccm INNER JOIN nrpcommissiontypes cot ON cot.id = ccm.nrpcommissionid WHERE ccm.contractid = a.contractid AND cot.NAME LIKE ( 'Client Brokerage%' )), 0) * mulpleVal  AS ClientBrokerage,
Isnull((SELECT TOP 1 CASE WHEN ccm.ispercentage = 1 THEN ccm.commission * (CASE WHEN ccm.isonnrp = 1 THEN ph.Premium ELSE ph.Premium END) / 100 ELSE ccm.commission END FROM nrpcommissioncontractmapping ccm INNER JOIN nrpcommissiontypes cot ON cot.id = ccm.nrpcommissionid WHERE ccm.contractid = a.contractid AND cot.NAME LIKE ( 'Insurer NRP Retention%' )), 0) * mulpleVal  AS cedentNrp,
Isnull((SELECT CASE WHEN ccm.ispercentage = 1 THEN ccm.commission * (CASE WHEN ccm.isonnrp = 1 THEN a.nrpUs ELSE a.grossPremium-(a.TotalTax/LocalCurrencyConversionRate) END) / 100 ELSE ccm.commission END FROM nrpcommissioncontractmapping ccm INNER JOIN nrpcommissiontypes cot ON cot.id = ccm.nrpcommissionid WHERE ccm.contractid = a.contractid AND cot.NAME LIKE ( 'Internal GoodWill%' )), 0) * mulpleVal  AS InternalGoodWill,
Isnull((SELECT CASE WHEN ccm.ispercentage = 1 THEN ccm.commission * (CASE WHEN ccm.isonnrp = 1 THEN a.nrpUs ELSE a.grossPremium-(a.TotalTax/LocalCurrencyConversionRate) END) / 100 ELSE ccm.commission END FROM nrpcommissioncontractmapping ccm INNER JOIN nrpcommissiontypes cot ON cot.id = ccm.nrpcommissionid WHERE ccm.contractid = a.contractid AND cot.NAME LIKE ( 'Dealer Commission%' )), 0) * mulpleVal  AS DealerCommission,
0 as grossPremiumLessComm,
Isnull((SELECT TOP 1 CASE WHEN ccm.ispercentage = 1 THEN ccm.commission * (CASE WHEN ccm.isonnrp = 1 THEN ph.Premium ELSE ph.Premium END) / 100 ELSE ccm.commission END FROM nrpcommissioncontractmapping ccm INNER JOIN nrpcommissiontypes cot ON cot.id = ccm.nrpcommissionid WHERE ccm.contractid = a.contractid AND cot.NAME LIKE ( 'Reinsurer Brokerage%' )),0) * mulpleVal  AS brokerage,
a.nrpUs * mulpleVal  as netPremium,
Isnull((SELECT TOP 1 CASE WHEN ccm.ispercentage = 1 THEN ccm.commission * (CASE WHEN ccm.isonnrp = 1 THEN a.nrpUs ELSE a.grossPremium-(a.TotalTax/LocalCurrencyConversionRate) END) / 100 ELSE ccm.commission END FROM nrpcommissioncontractmapping ccm INNER JOIN nrpcommissiontypes cot ON cot.id = ccm.nrpcommissionid WHERE ccm.contractid = a.contractid AND cot.NAME LIKE ( '%Admin%' )), 0) * mulpleVal  AS gapAdminstrtion,
a.nrpUs * mulpleVal  as nrpUs,
ISNULL([BGT],0) * mulpleVal  AS BGT, ISNULL([CIGFL] , 0) * mulpleVal  CIGFL, ISNULL([CT],0) * mulpleVal  CT,ISNULL([ESC],0) * mulpleVal  ESC, ISNULL([IIT],0) * mulpleVal  IIT, ISNULL([NBTv],0) * mulpleVal  NBTv, ISNULL([ST],0) * mulpleVal  ST, ISNULL([STL],0) * mulpleVal  STL, ISNULL([VAT],0) * mulpleVal  VAT, ISNULL([WT] ,0)  * mulpleVal WT,ISNULL([BGTisApplied],0) AS BGTisApplied, ISNULL([CIGFLisApplied] , 0) CIGFLisApplied, ISNULL([CTisApplied],0) CTisApplied,ISNULL([ESCisApplied],0) ESCisApplied, ISNULL([IITisApplied],0) IITisApplied, ISNULL([NBTvisApplied],0) NBTvisApplied, ISNULL([STisApplied],0) STisApplied, ISNULL([STLisApplied],0) STLisApplied, ISNULL([VATisApplied],0) VATisApplied, ISNULL([WTisApplied] ,0) WTisApplied FROM      
( SELECT a.[PolicyNo] as PolicyNo, case a.IsPolicyCanceled when 1 then 'Cancelled' else 'Active' end as status, DateName( month , DateAdd( month , a.Month , -1 )) as month, 1 as noOfUnits, a.Premium as grossPremium, a.NRP as nrpUs, a.Id, a.contractid, a.dealerid, a.ContractExtensionPremiumId, a.BordxId , a.BordxCountryId,a.TotalTax,a.LocalCurrencyConversionRate , a.GrossPremiumBeforeTax ,case a.IsPolicyCanceled when 1 then -1 else 1 end mulpleVal FROM [dbo].[Policy] a union 
  SELECT a.[PolicyNo] as PolicyNo, ptt.description as status, DateName( month , DateAdd( month , a.Month , -1 )) as month, 1 as noOfUnits, a.Premium as grossPremium, a.NRP as nrpUs, a.Id, a.contractid, a.dealerid, a.ContractExtensionPremiumId, a.BordxId , a.BordxCountryId , a.TotalTax,a.LocalCurrencyConversionRate , a.GrossPremiumBeforeTax , case when ptt.code = 'Cancellation' then -1 else case when ptt.code = 'Transfer' then 0 else 1 end end mulpleVal FROM [dbo].[Policy] a INNER JOIN [dbo].[PolicyTransaction] pt ON pt.[PolicyId] = a.id INNER JOIN [dbo].[PolicyTransactionType] ptt ON pt.[TransactionTypeId] = ptt.id )a  
INNER JOIN [dbo].[Bordx] i on i.id = a.BordxId AND (datefromparts(i.[Year], i.[Month], 1) BETWEEN ( SELECT TOP 1 datefromparts([Year], [Month], 1) FROM [dbo].[Bordx] WHERE ID = @var4 ) AND ( SELECT TOP 1 datefromparts([Year], [Month], 1) FROM [dbo].[Bordx] WHERE ID = @var5 ))  
INNER JOIN [dbo].[contract] b ON b.id = a.contractid INNER JOIN [dbo].[ReinsurerContract] rinsc ON b.[ReinsurerContractId] = rinsc.id AND  rinsc.[ReinsurerId] = CASE WHEN UPPER(@var3)='ALL' THEN rinsc.[ReinsurerId] ELSE @var3 END  
INNER JOIN [dbo].[insurer] c ON c.id = b.insurerid  and b.insurerid = CASE WHEN UPPER(@var2)='ALL' THEN b.insurerid ELSE @var2 END   INNER JOIN [dbo].[dealer] d ON d.id = a.dealerid and a.dealerid = CASE WHEN UPPER(@var1)='ALL' THEN a.dealerid ELSE @var1 END  
INNER JOIN [dbo].[Country] e ON e.Id = a.BordxCountryId INNER JOIN [dbo].[Insurer] f ON f.Id = d.InsurerId INNER JOIN [dbo].[Currency] g ON g.Id = d.CurrencyId INNER JOIN [dbo].[ContractExtensionPremium] h ON h.Id = a.ContractExtensionPremiumId INNER JOIN [dbo].[ItemStatus] itst on itst.id = h.ItemStatusId LEFT JOIN [dbo].[VehiclePolicy] AS VP ON VP.PolicyId = a.Id LEFT JOIN [dbo].[VehicleDetails] AS VD ON VP.VehicleId = VD.Id  
LEFT JOIN ( SELECT CountryId, ISNULL([BGT],0) AS BGT, ISNULL([CIGFL] , 0) CIGFL, ISNULL([CT],0) CT,ISNULL([ESC],0) ESC, ISNULL([IIT],0) IIT, ISNULL([NBTv],0) NBTv, ISNULL([ST],0) ST, ISNULL([STL],0) STL, ISNULL([VAT],0) VAT, ISNULL([WT] ,0) WT FROM ( SELECT tt.TaxCode ,ct.TaxValue ,ct.CountryId FROM [dbo].[TaxTypes] tt INNER JOIN [dbo].[CountryTaxes] ct on ct.TaxTypeId = tt.Id ) AS j PIVOT ( SUM(TaxValue) FOR TaxCode IN ([BGT], [CIGFL], [CT], [ESC], [IIT], [NBTv], [ST], [STL], [VAT], [WT]) ) AS p)tct on tct.CountryId = a.BordxCountryId   
LEFT JOIN ( SELECT ContractId , ISNULL([BGT],0) AS BGTisApplied, ISNULL([CIGFL] , 0) CIGFLisApplied, ISNULL([CT],0) CTisApplied,ISNULL([ESC],0) ESCisApplied, ISNULL([IIT],0) IITisApplied, ISNULL([NBTv],0) NBTvisApplied, ISNULL([ST],0) STisApplied, ISNULL([STL],0) STLisApplied, ISNULL([VAT],0) VATisApplied, ISNULL([WT] ,0) WTisApplied FROM ( SELECT tt.TaxCode ,cnt.ContractId , CASE WHEN cnt.ContractId IS NULL THEN 0 ELSE 1 END AS taxApplicable FROM [dbo].[TaxTypes] tt INNER JOIN [dbo].[CountryTaxes] ct on ct.TaxTypeId = tt.Id INNER JOIN [dbo].[ContractTaxes] cnt on cnt.CountryTaxId = ct.Id ) AS j PIVOT ( MAX(taxApplicable) FOR TaxCode IN ([BGT], [CIGFL], [CT], [ESC], [IIT], [NBTv], [ST], [STL], [VAT], [WT]) ) AS p )tcta on tcta.ContractId = a.contractid    
LEFT JOIN policyhistory ph ON ph.policyid = a.id   
ORDER BY invoiceNo , policyNo ASC;